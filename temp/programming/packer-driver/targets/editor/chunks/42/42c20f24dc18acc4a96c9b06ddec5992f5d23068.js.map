{"version":3,"sources":["file:///Users/yinshi/study/pfq/project/HeroClash/assets/src/resource/currency/manager.ts"],"names":["CurrencyManager","Mutex","VisibleError","ERROR_CODES","currencyMutexID","storageCurrencyID","constructor","currencyCache","getCurrencyFromStorage","getInstance","instance","getCurrencyFromCache","storedData","localStorage","getItem","JSON","parse","console","log","getDefaultCurrency","copper","evolutionStone","ironOre","battleSoulStone","hetianJade","checkResource","currency","key","Object","keys","Math","abs","updateResource","lock","info","stringify","currentCurrency","tmp","error","Error","saveResources","news","unlock","message","code","LOCK_FAILED","setItem"],"mappings":"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","sourcesContent":["// 资源管理模块\n// 铜钱 进阶石 铁矿 战魂石 和田玉\nimport { CurrencyType, Currency } from \"./kind\";\nimport { Mutex } from \"../../utils/mutex\";\nimport { VisibleError, ERROR_CODES } from \"../../utils/errors\";\n\n// 货币资源互斥锁ID\nconst currencyMutexID = \"currency\";\n// 文件中的货币资源ID\nconst storageCurrencyID = \"currency\"\n\n// function sleep(ms: number): Promise<void> {\n//     return new Promise(resolve => setTimeout(resolve, ms));\n// }\n\n// 货币资源管理器\nexport class CurrencyManager {\n    // 货币资源管理器实例\n    private static instance: CurrencyManager;\n    // 货币缓存\n    private currencyCache: Currency;\n\n    private constructor() {\n        // 初始化缓存\n        this.currencyCache = this.getCurrencyFromStorage();\n    }\n\n    // 获取货币资源管理器的单例\n    public static getInstance(): CurrencyManager {\n        if (!CurrencyManager.instance) {\n            CurrencyManager.instance = new CurrencyManager();\n        }\n\n        return CurrencyManager.instance;\n    }\n\n    // 获取货币缓存\n    public getCurrencyFromCache(): Currency {\n        return this.currencyCache;\n    }\n\n    // 从存储中获取货币\n    public getCurrencyFromStorage(): Currency {\n        const storedData = localStorage.getItem(storageCurrencyID);\n        if (storedData) {\n            return JSON.parse(storedData);\n        }\n\n        console.log(\"not init currency resource, return default currency\");\n        return this.getDefaultCurrency();\n    }\n\n    // 获取默认的资源数据\n    private getDefaultCurrency(): Currency {\n        return {\n            copper: 0,\n            evolutionStone: 0,\n            ironOre: 0,\n            battleSoulStone: 0,\n            hetianJade: 0,\n        };\n    }\n\n    // 检查指定ID的资源是否足够\n    public checkResource(currency: Currency): boolean {\n        for (const key of Object.keys(currency) as (keyof Currency)[]) {\n            if (this.currencyCache[key] < Math.abs(currency[key])) {\n                return false;\n            }\n        }\n\n        return true;\n    }\n\n    // 更新货币资源\n    public async updateResource(currency: Currency): Promise<void> {\n        try {\n            await Mutex.getInstance().lock(currencyMutexID);\n            console.info(\"update currency %s\", JSON.stringify(currency));\n            let currentCurrency = this.getCurrencyFromStorage();\n            console.info(\"current currency %s\", JSON.stringify(currentCurrency));\n            for (const key of Object.keys(currency) as (keyof Currency)[]) {\n                let tmp = currentCurrency[key] + currency[key];\n                if (tmp < 0) {\n                    console.error(\"Failed to update currency, %s is not enough, current:%d, need: %d\",\n                        key, currentCurrency[key], Math.abs(currency[key]));\n                    throw new Error(`Failed to update currency: Insufficient resources`);\n                }\n\n                currentCurrency[key] = tmp;\n            }\n            // 保存更新后的资源\n            this.saveResources(currentCurrency);\n            // 更新缓存\n            this.currencyCache = currentCurrency;\n            let news = this.getCurrencyFromStorage();\n            console.info(\"after set is %s\", JSON.stringify(news));\n            Mutex.getInstance().unlock(currencyMutexID);\n        } catch (error) {\n            console.error(\"Failed to update currency, err: %s\", error.message);\n            if (error instanceof VisibleError) {\n                // 非加锁失败的错误需要解锁\n                if (error.code != ERROR_CODES.LOCK_FAILED) {\n                    Mutex.getInstance().unlock(currencyMutexID);\n                }\n            }\n\n            throw new Error(`Failed to update currency: ${error.message}`);\n        }\n    }\n\n    // 保存资源到本地存储\n    private saveResources(currency: Currency) {\n        try {\n            console.info(\"set %s resources %s\", storageCurrencyID, JSON.stringify(currency));\n            localStorage.setItem(storageCurrencyID, JSON.stringify(currency));\n        } catch (error) {\n            console.error(\"save %s resources failed, error: %s\", storageCurrencyID, error.message);\n            throw new Error(`Failed to save currency: ${error.message}`);\n        }\n    }\n}"]}